<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>What are quosures and when are they needed? — topic-quosure • rlang</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="What are quosures and when are they needed? — topic-quosure"><meta name="description" content="A quosure is a special type of defused expression that keeps track of the original context the expression was written in. The tracking capabilities of quosures is important when interfacing data-masking functions together because the functions might come from two unrelated environments, like two different packages."><meta property="og:description" content="A quosure is a special type of defused expression that keeps track of the original context the expression was written in. The tracking capabilities of quosures is important when interfacing data-masking functions together because the functions might come from two unrelated environments, like two different packages."><meta property="og:image" content="https://rlang.r-lib.org/logo.png"><meta name="robots" content="noindex"><script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-hide-below="1200" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="rlang.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rlang</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.6.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tidy-evaluation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tidy evaluation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tidy-evaluation"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask.html">What is data-masking and why do I need `{{`?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-programming.html">Data mask programming patterns</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-ambiguity.html">The data mask ambiguity</a></li>
    <li><a class="dropdown-item" href="../reference/topic-double-evaluation.html">The double evaluation problem</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-inject-out-of-context.html">What happens if I use injection operators out of context?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-non-args.html">Does `{{` work on regular objects?</a></li>
  </ul></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-metaprogramming" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Metaprogramming</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-metaprogramming"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-defuse.html">Defusing R expressions</a></li>
    <li><a class="dropdown-item" href="../reference/topic-inject.html">Injecting with `!!`, `!!!`, and glue syntax</a></li>
    <li><a class="dropdown-item" href="../reference/topic-metaprogramming.html">Metaprogramming patterns</a></li>
    <li><a class="dropdown-item" href="../reference/topic-quosure.html">What are quosures and when are they needed?</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-multiple-columns.html">Taking multiple columns without `...`</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-constants.html">Why are strings and other constants enquosed in the empty environment?</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-conditions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Conditions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-conditions"><li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-error-call.html">Including function calls in error messages</a></li>
    <li><a class="dropdown-item" href="../reference/topic-error-chaining.html">Including contextual information with error chains</a></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-formatting.html">Formatting messages with cli</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-customisation.html">Customising condition messages</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/">Version 0.4.3</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/">Version 0.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/rlang-0-3-1/">Version 0.3.1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/10/rlang-0-3-0/">Version 0.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/03/rlang-0.2.0/">Version 0.2.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/rlang/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>What are quosures and when are they needed?</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/rlang/blob/main/R/topic-nse.R" class="external-link"><code>R/topic-nse.R</code></a></small>
      <div class="d-none name"><code>topic-quosure.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>A quosure is a special type of <a href="topic-defuse.html">defused expression</a> that keeps track of the original context the expression was written in. The tracking capabilities of quosures is important when interfacing <a href="topic-data-mask.html">data-masking</a> functions together because the functions might come from two unrelated environments, like two different packages.</p>
    </div>


    <div class="section level2">
    <h2 id="blending-environments">Blending environments<a class="anchor" aria-label="anchor" href="#blending-environments"></a></h2>
    <p>Let's take an example where the R user calls the function <code>summarise_bmi()</code> from the foo package to summarise a data frame with statistics of a BMI value. Because the <code>height</code> variable of their data frame is not in metres, they use a custom function <code>div100()</code> to rescale the column.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># Global environment of user</span></span>
<span></span>
<span><span class="va">div100</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">x</span> <span class="op">/</span> <span class="fl">100</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">dplyr</span><span class="fu">::</span><span class="va"><a href="https://dplyr.tidyverse.org/reference/starwars.html" class="external-link">starwars</a></span> <span class="op">%&gt;%</span></span>
<span>  <span class="fu">foo</span><span class="fu">::</span><span class="fu">summarise_bmi</span><span class="op">(</span><span class="va">mass</span>, <span class="fu">div100</span><span class="op">(</span><span class="va">height</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>The <code>summarise_bmi()</code> function is a data-masking function defined in the namespace of the foo package which looks like this:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># Namespace of package foo</span></span>
<span></span>
<span><span class="va">bmi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mass</span>, <span class="va">height</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mass</span> <span class="op">/</span> <span class="va">height</span><span class="op">^</span><span class="fl">2</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">summarise_bmi</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">mass</span>, <span class="va">height</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">bar</span><span class="fu">::</span><span class="fu">summarise_stats</span><span class="op">(</span><span class="fu">bmi</span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">mass</span> <span class="op">}</span><span class="op">}</span>, <span class="op">{</span><span class="op">{</span> <span class="va">height</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>The foo package uses the custom function <code>bmi()</code> to perform a computation on two vectors. It interfaces with <code>summarise_stats()</code> defined in bar, another package whose namespace looks like this:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="co"># Namespace of package bar</span></span>
<span></span>
<span><span class="va">check_numeric</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">x</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">summarise_stats</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>      var <span class="op">=</span> <span class="fu">check_numeric</span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span></span>
<span>      mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>      sd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>Again the package bar uses a custom function, <code>check_numeric()</code>, to validate its input. It also interfaces with data-masking functions from dplyr (using the <a href="topic-double-evaluation.html">define-a-constant</a> trick to avoid issues of double evaluation).</p>
<p>There are three data-masking functions simultaneously interfacing in this snippet:</p><ul><li><p>At the bottom, <code><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">dplyr::transmute()</a></code> takes a data-masked input, and creates a data frame of a single column named <code>var</code>.</p></li>
<li><p>Before this, <code>bar::summarise_stats()</code> takes a data-masked input inside <code><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">dplyr::transmute()</a></code> and checks it is numeric.</p></li>
<li><p>And first of all, <code>foo::summarise_bmi()</code> takes two data-masked inputs inside <code>bar::summarise_stats()</code> and transforms them to a single BMI value.</p></li>
</ul><p>There is a fourth context, the global environment where <code>summarise_bmi()</code> is called with two columns defined in a data frame, one of which is transformed on the fly with the user function <code>div100()</code>.</p>
<p>All of these contexts (except to some extent the global environment) contain functions that are private and invisible to foreign functions. Yet, the final expanded data-masked expression that is evaluated down the line looks like this (with caret characters indicating the quosure boundaries):</p>
<p></p><div class="sourceCode r"><pre><code>dplyr::transmute(
  var = ^check_numeric(^bmi(^mass, ^div100(height)))
)
</code></pre><p></p></div>
<p>The role of quosures is to let R know that <code>check_numeric()</code> should be found in the bar package, <code>bmi()</code> in the foo package, and <code>div100()</code> in the global environment.</p>
    </div>
    <div class="section level2">
    <h2 id="when-should-i-create-quosures-">When should I create quosures?<a class="anchor" aria-label="anchor" href="#when-should-i-create-quosures-"></a></h2>
    <p>As a tidyverse user you generally don't need to worry about quosures because <code>{{</code> and <code>...</code> will create them for you. Introductory texts like <a href="https://dplyr.tidyverse.org/articles/programming.html" class="external-link">Programming with dplyr</a> or the <a href="topic-data-mask-programming.html">standard data-mask programming patterns</a> don't even mention the term. In more complex cases you might need to create quosures with <code><a href="enquo.html">enquo()</a></code> or <code><a href="enquo.html">enquos()</a></code> (even though you generally don't need to know or care that these functions return quosures). In this section, we explore when quosures are necessary in these more advanced applications.</p><div class="section">
<h3 id="foreign-and-local-expressions">Foreign and local expressions<a class="anchor" aria-label="anchor" href="#foreign-and-local-expressions"></a></h3>


<p>As a rule of thumb, quosures are only needed for arguments defused with <code><a href="enquo.html">enquo()</a></code> or <code><a href="enquo.html">enquos()</a></code> (or with <code><a href="embrace-operator.html">{{</a></code> which calls <code><a href="enquo.html">enquo()</a></code> implicitly):</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  <span class="fu">their_function</span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Equivalently</span></span>
<span><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">their_function</span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>Wrapping defused arguments in quosures is needed because expressions supplied as argument comes from a different environment, the environment of your user. For local expressions created in your function, you generally don't need to create quosures:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># `expr()` is sufficient, no need for `quo()`</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expr.html">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">!</span><span class="op">!</span><span class="va">expr</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_mean</span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 x 1</span></span>
<span><span class="co">#&gt;   `mean(cyl)`</span></span>
<span><span class="co">#&gt;         &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1        6.19</span></span></code></pre><p></p></div>
<p>Using <code><a href="defusing-advanced.html">quo()</a></code> instead of <code><a href="expr.html">expr()</a></code> would have worked too but it is superfluous because <code><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">dplyr::summarise()</a></code>, which uses <code><a href="enquo.html">enquos()</a></code>, is already in charge of wrapping your expression within a quosure scoped in your environment.</p>
<p>The same applies if you evaluate manually. By default, <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> and <code><a href="eval_tidy.html">eval_tidy()</a></code> capture your environment:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expr.html">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/eval_tidy.html">eval_tidy</a></span><span class="op">(</span><span class="va">expr</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_mean</span><span class="op">(</span><span class="va">mtcars</span>, <span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.1875</span></span></code></pre><p></p></div>
</div>

<div class="section">
<h3 id="external-defusing">External defusing<a class="anchor" aria-label="anchor" href="#external-defusing"></a></h3>


<p>An exception to this rule of thumb (wrap foreign expressions in quosures, not your own expressions) arises when your function takes multiple expressions in a list instead of <code>...</code>. The preferred approach in that case is to take a tidy selection so that users can combine multiple columns using <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. If that is not possible, you can take a list of externally defused expressions:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_group_by</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="../reference/new_quosures.html">is_quosures</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">my_group_by</span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">am</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>In this pattern, <code><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">dplyr::vars()</a></code> defuses expressions externally. It creates a list of quosures because the expressions are passed around from function to function like regular arguments. In fact, <code><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">dplyr::vars()</a></code> and <code>ggplot2::vars()</code> are simple aliases of <code><a href="defusing-advanced.html">quos()</a></code>.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">cyl</span>, <span class="va">am</span><span class="op">)</span></span>
<span><span class="co">#&gt; &lt;list_of&lt;quosure&gt;&gt;</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span><span class="co">#&gt; expr: ^cyl</span></span>
<span><span class="co">#&gt; env:  global</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; &lt;quosure&gt;</span></span>
<span><span class="co">#&gt; expr: ^am</span></span>
<span><span class="co">#&gt; env:  global</span></span></code></pre><p></p></div>
<p>For more information about external defusing, see <a href="topic-multiple-columns.html">Taking multiple columns without ...</a>.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="technical-description-of-quosures">Technical description of quosures<a class="anchor" aria-label="anchor" href="#technical-description-of-quosures"></a></h2>
    <p>A quosure carries two things:</p><ul><li><p>An expression (get it with <code><a href="quosure-tools.html">quo_get_expr()</a></code>).</p></li>
<li><p>An environment (get it with <code><a href="quosure-tools.html">quo_get_env()</a></code>).</p></li>
</ul><p>And implements these behaviours:</p><ul><li><p>It is <em>callable</em>. Evaluation produces a result.</p>
<p>For historical reasons, <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">base::eval()</a></code> doesn't support quosure evaluation. Quosures currently require <code><a href="eval_tidy.html">eval_tidy()</a></code>. We would like to fix this limitation in the future.</p></li>
<li><p>It is <em>hygienic</em>. It evaluates in the tracked environment.</p></li>
<li><p>It is <em>maskable</em>. If evaluated in a data mask (currently only masks created with <code><a href="eval_tidy.html">eval_tidy()</a></code> or <code><a href="as_data_mask.html">new_data_mask()</a></code>), the mask comes first in scope before the quosure environment.</p>
<p>Conceptually, a quosure inherits from two chains of environments, the data mask and the user environment. In practice rlang implements this special scoping by rechaining the top of the data mask to the quosure environment currently under evaluation.</p></li>
</ul><p>There are similarities between promises (the ones R uses to implement lazy evaluation, not the async expressions from the promises package) and quosures. One important difference is that promises are only evaluated once and cache the result for subsequent evaluation. Quosures behave more like calls and can be evaluated repeatedly, potentially in a different data mask. This property is useful to implement split-apply-combine evaluations.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>

<ul><li><p><code><a href="enquo.html">enquo()</a></code> and <code><a href="enquo.html">enquos()</a></code> to defuse function arguments as quosures. This is the main way quosures are created.</p></li>
<li><p><code><a href="defusing-advanced.html">quo()</a></code> which is like <code><a href="expr.html">expr()</a></code> but wraps in a quosure. Usually it is not needed to wrap local expressions yourself.</p></li>
<li><p><code><a href="quosure-tools.html">quo_get_expr()</a></code> and <code><a href="quosure-tools.html">quo_get_env()</a></code> to access quosure components.</p></li>
<li><p><code><a href="new_quosure.html">new_quosure()</a></code> and <code><a href="new_quosure.html">as_quosure()</a></code> to assemble a quosure from components.</p></li>
</ul></div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

  </div></footer></body></html>

