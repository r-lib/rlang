<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Metaprogramming patterns — topic-metaprogramming • rlang</title><!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png"><link rel="icon" type="”image/svg+xml”" href="../favicon.svg"><link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png"><link rel="icon" sizes="any" href="../favicon.ico"><link rel="manifest" href="../site.webmanifest"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.10/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Metaprogramming patterns — topic-metaprogramming"><meta name="description" content="The patterns covered in this article rely on metaprogramming, the ability to defuse, create, expand, and inject R expressions. A good place to start if you're new to programming on the language is the Metaprogramming chapter of the Advanced R book.
If you haven't already, read Data mask programming patterns which covers simpler patterns that do not require as much theory to get up to speed. It covers concepts like argument behaviours and the various patterns you can add to your toolbox (forwarding, names, bridge, and transformative patterns)."><meta property="og:description" content="The patterns covered in this article rely on metaprogramming, the ability to defuse, create, expand, and inject R expressions. A good place to start if you're new to programming on the language is the Metaprogramming chapter of the Advanced R book.
If you haven't already, read Data mask programming patterns which covers simpler patterns that do not require as much theory to get up to speed. It covers concepts like argument behaviours and the various patterns you can add to your toolbox (forwarding, names, bridge, and transformative patterns)."><meta property="og:image" content="https://rlang.r-lib.org/logo.png"><meta name="robots" content="noindex"><script src="https://cdn.jsdelivr.net/gh/posit-dev/supported-by-posit/js/badge.min.js" data-hide-below="1200" data-max-height="43" data-light-bg="#666f76" data-light-fg="#f9f9f9"></script><script defer data-domain="rlang.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rlang</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.6.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tidy-evaluation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tidy evaluation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tidy-evaluation"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask.html">What is data-masking and why do I need `{{`?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-programming.html">Data mask programming patterns</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-ambiguity.html">The data mask ambiguity</a></li>
    <li><a class="dropdown-item" href="../reference/topic-double-evaluation.html">The double evaluation problem</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-inject-out-of-context.html">What happens if I use injection operators out of context?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-non-args.html">Does `{{` work on regular objects?</a></li>
  </ul></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-metaprogramming" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Metaprogramming</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-metaprogramming"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-defuse.html">Defusing R expressions</a></li>
    <li><a class="dropdown-item" href="../reference/topic-inject.html">Injecting with `!!`, `!!!`, and glue syntax</a></li>
    <li><a class="dropdown-item" href="../reference/topic-metaprogramming.html">Metaprogramming patterns</a></li>
    <li><a class="dropdown-item" href="../reference/topic-quosure.html">What are quosures and when are they needed?</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-multiple-columns.html">Taking multiple columns without `...`</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-constants.html">Why are strings and other constants enquosed in the empty environment?</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-conditions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Conditions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-conditions"><li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-error-call.html">Including function calls in error messages</a></li>
    <li><a class="dropdown-item" href="../reference/topic-error-chaining.html">Including contextual information with error chains</a></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-formatting.html">Formatting messages with cli</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-customisation.html">Customising condition messages</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/">Version 0.4.3</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/">Version 0.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/rlang-0-3-1/">Version 0.3.1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/10/rlang-0-3-0/">Version 0.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/03/rlang-0.2.0/">Version 0.2.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/rlang/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Metaprogramming patterns</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/rlang/blob/main/R/topic-nse.R" class="external-link"><code>R/topic-nse.R</code></a></small>
      <div class="d-none name"><code>topic-metaprogramming.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>The patterns covered in this article rely on <em>metaprogramming</em>, the ability to defuse, create, expand, and inject R expressions. A good place to start if you're new to programming on the language is the <a href="https://adv-r.hadley.nz/metaprogramming.html" class="external-link">Metaprogramming chapter</a> of the <a href="https://adv-r.hadley.nz" class="external-link">Advanced R</a> book.</p>
<p>If you haven't already, read <a href="topic-data-mask-programming.html">Data mask programming patterns</a> which covers simpler patterns that do not require as much theory to get up to speed. It covers concepts like argument behaviours and the various patterns you can add to your toolbox (forwarding, names, bridge, and transformative patterns).</p>
    </div>


    <div class="section level2">
    <h2 id="forwarding-patterns">Forwarding patterns<a class="anchor" aria-label="anchor" href="#forwarding-patterns"></a></h2>

<div class="section">
<h3 id="defuse-and-inject">Defuse and inject<a class="anchor" aria-label="anchor" href="#defuse-and-inject"></a></h3>


<p><code><a href="embrace-operator.html">{{</a></code> and <code>...</code> are sufficient for most purposes. Sometimes however, it is necessary to decompose the forwarding action into its two constitutive steps, <a href="topic-defuse.html">defusing</a> and <a href="topic-inject.html">injecting</a>.</p>
<p><code>{{</code> is the combination of <code><a href="enquo.html">enquo()</a></code> and <code><a href="injection-operator.html">!!</a></code>. These functions are completely equivalent:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_summarise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="op">{</span><span class="op">{</span> <span class="va">var</span> <span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_summarise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>Passing <code>...</code> is equivalent to the combination of <code><a href="enquo.html">enquos()</a></code> and <code><a href="splice-operator.html">!!!</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_group_by</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">.data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">my_group_by</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">.data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/enquo.html">enquos</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre><p></p></div>
<p>The advantage of decomposing the steps is that you gain access to the <a href="topic-defuse.html">defused expressions</a>. Once defused, you can inspect or modify the expressions before injecting them in their target context.</p>
</div>

<div class="section">
<h3 id="inspecting-input-labels">Inspecting input labels<a class="anchor" aria-label="anchor" href="#inspecting-input-labels"></a></h3>


<p>For instance, here is how to create an automatic name for a defused argument using <code><a href="as_label.html">as_label()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/as_label.html">as_label</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cyl"</span></span>
<span></span>
<span><span class="fu">f</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1 + 1"</span></span></code></pre><p></p></div>
<p>This is essentially equivalent to formatting an argument using <code><a href="englue.html">englue()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/englue.html">englue</a></span><span class="op">(</span><span class="st">"{{ var }}"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">f2</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "1 + 1"</span></span></code></pre><p></p></div>
<p>With multiple arguments, use the plural variant <code><a href="enquo.html">enquos()</a></code>. Set <code>.named</code> to <code>TRUE</code> to automatically call <code><a href="as_label.html">as_label()</a></code> on the inputs for which the user has not provided a name (the same behaviour as in most dplyr verbs):</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquos</a></span><span class="op">(</span><span class="va">...</span>, .named <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">g</span><span class="op">(</span><span class="va">cyl</span>, <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "cyl"   "1 + 1"</span></span></code></pre><p></p></div>
<p>Just like with <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">dplyr::mutate()</a></code>, the user can override automatic names by supplying explicit names:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu">g</span><span class="op">(</span>foo <span class="op">=</span> <span class="va">cyl</span>, bar <span class="op">=</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] "foo" "bar"</span></span></code></pre><p></p></div>
<p>Defuse-and-inject patterns are most useful for transforming inputs. Some applications are explored in the Transformation patterns section.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="names-patterns">Names patterns<a class="anchor" aria-label="anchor" href="#names-patterns"></a></h2>

<div class="section">
<h3 id="symbolise-and-inject">Symbolise and inject<a class="anchor" aria-label="anchor" href="#symbolise-and-inject"></a></h3>


<p>The symbolise-and-inject pattern is a <em>names pattern</em> that you can use when <code>across(all_of())</code> is not supported. It consists in creating <a href="topic-defuse.html">defused expressions</a> that refer to the data-variables represented in the names vector. These are then injected in the data mask context.</p>
<p>Symbolise a single string with <code><a href="sym.html">sym()</a></code> or <code><a href="sym.html">data_sym()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="st">"cyl"</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="co">#&gt; cyl</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sym.html">data_sym</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="co">#&gt; .data$cyl</span></span></code></pre><p></p></div>
<p>Symbolise a character vector with <code><a href="sym.html">syms()</a></code> or <code><a href="sym.html">data_syms()</a></code>.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyl"</span>, <span class="st">"am"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sym.html">syms</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; cyl</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; am</span></span>
<span></span>
<span><span class="fu"><a href="../reference/sym.html">data_syms</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="co">#&gt; [[1]]</span></span>
<span><span class="co">#&gt; .data$cyl</span></span>
<span><span class="co">#&gt;</span></span>
<span><span class="co">#&gt; [[2]]</span></span>
<span><span class="co">#&gt; .data$am</span></span></code></pre><p></p></div>
<p>Simple symbols returned by <code><a href="sym.html">sym()</a></code> and <code><a href="sym.html">syms()</a></code> work in a wider variety of cases (with base functions in particular) but we'll use mostly use <code><a href="sym.html">data_sym()</a></code> and <code><a href="sym.html">data_syms()</a></code> because they are more robust (see <a href="topic-data-mask-ambiguity.html">The data mask ambiguity</a>). Note that these do not return <em>symbols</em> per se, instead they create <em>calls</em> to <code>$</code> that subset the <code><a href="dot-data.html">.data</a></code> pronoun.</p>
<p>Since the <code>.data</code> pronoun is a tidy eval feature, you can't use it in base functions. As a rule, prefer the <code>data_</code>-prefixed variants when you're injecting in tidy eval functions and the unprefixed functions for base functions.</p>
<p>A list of symbols can be injected in data-masked dots with the splice operator <code><a href="splice-operator.html">!!!</a></code>, which injects each element of the list as a separate argument. For instance, to implement a <code>group_by()</code> variant that takes a character vector of column names, you might write:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_group_by</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">vars</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/sym.html">data_syms</a></span><span class="op">(</span><span class="va">vars</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu">my_group_by</span><span class="op">(</span><span class="va">vars</span><span class="op">)</span></span></code></pre><p></p></div>
<p>In more complex case, you might want to add R code around the symbols. This requires <em>transformation</em> patterns, see the section below.</p>
</div>

    </div>
    <div class="section level2">
    <h2 id="bridge-patterns">Bridge patterns<a class="anchor" aria-label="anchor" href="#bridge-patterns"></a></h2>

<div class="section">
<h3 id="mutate-as-a-data-mask-to-selection-bridge"><code>mutate()</code> as a data-mask to selection bridge<a class="anchor" aria-label="anchor" href="#mutate-as-a-data-mask-to-selection-bridge"></a></h3>


<p>This is a variant of the <code>transmute()</code> bridge pattern described in <a href="topic-data-mask-programming.html">Data mask programming patterns</a> that does not materialise <code>...</code> in the intermediate step. Instead, the <code>...</code> expressions are defused and inspected. Then the expressions, rather than the columns, are spliced in <code>mutate()</code>.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_pivot_longer</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Defuse the dots and inspect the names</span></span>
<span>  <span class="va">dots</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquos</a></span><span class="op">(</span><span class="va">...</span>, .named <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="va">names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">dots</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Pass the inputs to `mutate()`</span></span>
<span>  <span class="va">data</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">dots</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Select `...` inputs by name with `all_of()`</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu">pivot_longer</span><span class="op">(</span>cols <span class="op">=</span> <span class="fu">all_of</span><span class="op">(</span><span class="va">names</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">my_pivot_longer</span><span class="op">(</span><span class="va">cyl</span>, am <span class="op">=</span> <span class="va">am</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span></code></pre><p></p></div><ol><li><p>Defuse the <code>...</code> expressions. The <code>.named</code> argument ensures unnamed inputs get a default name, just like they would if passed to <code>mutate()</code>. Take the names of the list of inputs.</p></li>
<li><p>Once we have the names, inject the argument expressions into <code>mutate()</code> to update the data frame.</p></li>
<li><p>Finally, pass the names to the tidy selection via <a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link"><code>all_of()</code></a>.</p></li>
</ol></div>

    </div>
    <div class="section level2">
    <h2 id="transformation-patterns">Transformation patterns<a class="anchor" aria-label="anchor" href="#transformation-patterns"></a></h2>

<div class="section">
<h3 id="transforming-inputs-manually">Transforming inputs manually<a class="anchor" aria-label="anchor" href="#transforming-inputs-manually"></a></h3>


<p>If <code>across()</code> and variants are not available, you will need to transform the inputs yourself using metaprogramming techniques. To illustrate the technique we'll reimplement <code>my_mean()</code> and without using <code>across()</code>. The pattern consists in defusing the input expression, building larger calls around them, and finally inject the modified expressions inside the data-masking functions.</p>
<p>We'll start with a single named argument for simplicity:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Defuse the expression</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquo</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Wrap it in a call to `mean()`</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/expr.html">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">var</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Inject the expanded expression</span></span>
<span>  <span class="va">data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="op">!</span><span class="op">!</span><span class="va">var</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">my_mean</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 x 1</span></span>
<span><span class="co">#&gt;    mean</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  6.19</span></span></code></pre><p></p></div>
<p>With <code>...</code> the technique is similar, though a little more involved. We'll use the plural variants <code><a href="enquo.html">enquos()</a></code> and <code><a href="splice-operator.html">!!!</a></code>. We'll also loop over the variable number of inputs using <code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">purrr::map()</a></code>. But the pattern is otherwise basically the same:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">my_mean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">.data</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># Defuse the dots. Make sure they are automatically named.</span></span>
<span>  <span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/enquo.html">enquos</a></span><span class="op">(</span><span class="va">...</span>, .named <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Map over each defused expression and wrap it in a call to `mean()`</span></span>
<span>  <span class="va">vars</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">vars</span>, <span class="op">~</span> <span class="fu"><a href="../reference/expr.html">expr</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Inject the expressions</span></span>
<span>  <span class="va">.data</span> <span class="op">%&gt;%</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="op">!</span><span class="va">vars</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">my_mean</span><span class="op">(</span><span class="va">cyl</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 x 1</span></span>
<span><span class="co">#&gt;     cyl</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  6.19</span></span></code></pre><p></p></div>
<p>Note that we are inheriting the data-masking behaviour of <code>summarise()</code> because we have effectively forwarded <code>...</code> inside that verb. This is different than transformation patterns based on <code>across()</code> which inherit tidy selection behaviour. In practice, this means the function doesn't support selection helpers and syntax. Instead, it gains the ability to create new vectors on the fly:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">mtcars</span> <span class="op">%&gt;%</span> <span class="fu">my_mean</span><span class="op">(</span>cyl <span class="op">=</span> <span class="va">cyl</span> <span class="op">*</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 1 x 1</span></span>
<span><span class="co">#&gt;     cyl</span></span>
<span><span class="co">#&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1  619.</span></span></code></pre><p></p></div>
</div>

    </div>
    <div class="section level2">
    <h2 id="base-patterns">Base patterns<a class="anchor" aria-label="anchor" href="#base-patterns"></a></h2>
    <p>In this section, we review patterns for programming with <em>base</em> data-masking functions. They essentially consist in building and evaluating expressions in the data mask. We review these patterns and compare them to rlang idioms.</p><div class="section">
<h3 id="data-masked-get-">Data-masked <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code><a class="anchor" aria-label="anchor" href="#data-masked-get-"></a></h3>


<p>In the simplest version of this pattern, <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> is called with a variable name to retrieve objects from the data mask:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var</span> <span class="op">&lt;-</span> <span class="st">"cyl"</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.1875</span></span></code></pre><p></p></div>
<p>This sort of pattern is susceptible to <a href="topic-data-mask-ambiguity.html">names collisions</a>. For instance, the input data frame might contain a variable called <code>var</code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>var <span class="op">=</span> <span class="st">"wrong"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/get.html" class="external-link">get</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `get()`:</span></span>
<span><span class="co">#&gt; ! object 'wrong' not found</span></span></code></pre><p></p></div>
<p>In general, prefer symbol injection over <code><a href="https://rdrr.io/r/base/get.html" class="external-link">get()</a></code> to prevent this sort of collisions. With base functions you will need to enable injection operators explicitly using <code><a href="inject.html">inject()</a></code>:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu"><a href="../reference/inject.html">inject</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 6.1875</span></span></code></pre><p></p></div>
<p>See <a href="topic-data-mask-ambiguity.html">The data mask ambiguity</a> for more information about names collisions.</p>
</div>

<div class="section">
<h3 id="data-masked-parse-and-eval-">Data-masked <code><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse()</a></code> and <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code><a class="anchor" aria-label="anchor" href="#data-masked-parse-and-eval-"></a></h3>


<p>A more involved pattern consists in building R code in a string and evaluating it in the mask:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var1</span> <span class="op">&lt;-</span> <span class="st">"am"</span></span>
<span><span class="va">var2</span> <span class="op">&lt;-</span> <span class="st">"vs"</span></span>
<span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">var1</span>, <span class="st">"=="</span>, <span class="va">var2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.59375</span></span></code></pre><p></p></div>
<p>As before, the <code>code</code> variable is vulnerable to <a href="topic-data-mask-ambiguity.html">names collisions</a>. More importantly, if <code>var1</code> and <code>var2</code> are user inputs, they could contain <a href="https://xkcd.com/327/" class="external-link">adversarial code</a>. Evaluating code assembled from strings is always a risky business:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var1</span> <span class="op">&lt;-</span> <span class="st">"(function() {</span></span>
<span><span class="st">  Sys.sleep(Inf)  # Could be a coin mining routine</span></span>
<span><span class="st">})()"</span></span>
<span><span class="va">var2</span> <span class="op">&lt;-</span> <span class="st">"vs"</span></span>
<span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">var1</span>, <span class="st">"=="</span>, <span class="va">var2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre><p></p></div>
<p>This is not a big deal if your code is only used internally. However, this code could be part of a public Shiny app which Internet users could exploit. But even internally, parsing is a source of bugs when variable names contain syntactic symbols like <code>-</code> or <code>:</code>.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var1</span> <span class="op">&lt;-</span> <span class="st">":var:"</span></span>
<span><span class="va">var2</span> <span class="op">&lt;-</span> <span class="st">"vs"</span></span>
<span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">var1</span>, <span class="st">"=="</span>, <span class="va">var2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/parse.html" class="external-link">parse</a></span><span class="op">(</span>text <span class="op">=</span> <span class="va">code</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error in `parse()`:</span></span>
<span><span class="co">#&gt; ! &lt;text&gt;:1:1: unexpected ':'</span></span>
<span><span class="co">#&gt; 1: :</span></span>
<span><span class="co">#&gt;     ^</span></span></code></pre><p></p></div>
<p>For these reasons, always prefer to <em>build</em> code instead of parsing code. Building variable names with <code><a href="sym.html">sym()</a></code> is a way of sanitising inputs.</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var1</span> <span class="op">&lt;-</span> <span class="st">"(function() {</span></span>
<span><span class="st">  Sys.sleep(Inf)  # Could be a coin mining routine</span></span>
<span><span class="st">})()"</span></span>
<span><span class="va">var2</span> <span class="op">&lt;-</span> <span class="st">"vs"</span></span>
<span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/call.html" class="external-link">call</a></span><span class="op">(</span><span class="st">"=="</span>, <span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span>, <span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">code</span></span>
<span><span class="co">#&gt; `(function() {\n  Sys.sleep(Inf)  # Could be a coin mining routine\n})()` ==</span></span>
<span><span class="co">#&gt;     vs</span></span></code></pre><p></p></div>
<p>The adversarial input now produces an error:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">code</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Error:</span></span>
<span><span class="co">#&gt; ! object '(function() {\n  Sys.sleep(Inf)  # Could be a coin mining routine\n})()' not found</span></span></code></pre><p></p></div>
<p>Finally, it is recommended to inject the code instead of evaluating it to avoid names collisions:</p>
<p></p><div class="sourceCode r"><pre><code><span><span class="va">var1</span> <span class="op">&lt;-</span> <span class="st">"am"</span></span>
<span><span class="va">var2</span> <span class="op">&lt;-</span> <span class="st">"vs"</span></span>
<span></span>
<span><span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/call.html" class="external-link">call</a></span><span class="op">(</span><span class="st">"=="</span>, <span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var1</span><span class="op">)</span>, <span class="fu"><a href="../reference/sym.html">sym</a></span><span class="op">(</span><span class="va">var2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/inject.html">inject</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">mtcars</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="op">!</span><span class="op">!</span><span class="va">code</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.59375</span></span></code></pre><p></p></div>
</div>

    </div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

  </div></footer></body></html>

