<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Evaluate an expression with quosures and pronoun support — eval_tidy • rlang</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Evaluate an expression with quosures and pronoun support — eval_tidy"><meta name="description" content="eval_tidy() is a variant of base::eval() that powers the tidy
evaluation framework. Like eval() it accepts user data as
argument. Whereas eval() simply transforms the data to an
environment, eval_tidy() transforms it to a data mask with as_data_mask(). Evaluating in a data
mask enables the following features:
Quosures. Quosures are expressions bundled with
an environment. If data is supplied, objects in the data mask
always have precedence over the quosure environment, i.e. the
data masks the environment.
Pronouns. If data is supplied, the .env and .data
pronouns are installed in the data mask. .env is a reference to
the calling environment and .data refers to the data
argument. These pronouns are an escape hatch for the data mask ambiguity problem.

"><meta property="og:description" content="eval_tidy() is a variant of base::eval() that powers the tidy
evaluation framework. Like eval() it accepts user data as
argument. Whereas eval() simply transforms the data to an
environment, eval_tidy() transforms it to a data mask with as_data_mask(). Evaluating in a data
mask enables the following features:
Quosures. Quosures are expressions bundled with
an environment. If data is supplied, objects in the data mask
always have precedence over the quosure environment, i.e. the
data masks the environment.
Pronouns. If data is supplied, the .env and .data
pronouns are installed in the data mask. .env is a reference to
the calling environment and .data refers to the data
argument. These pronouns are an escape hatch for the data mask ambiguity problem.

"><meta property="og:image" content="https://rlang.r-lib.org/logo.png"><meta name="robots" content="noindex"><script defer data-domain="rlang.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script></head><body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rlang</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">1.1.4.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-tidy-evaluation" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Tidy evaluation</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-tidy-evaluation"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask.html">What is data-masking and why do I need `{{`?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-programming.html">Data mask programming patterns</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-data-mask-ambiguity.html">The data mask ambiguity</a></li>
    <li><a class="dropdown-item" href="../reference/topic-double-evaluation.html">The double evaluation problem</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-inject-out-of-context.html">What happens if I use injection operators out of context?</a></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-non-args.html">Does `{{` work on regular objects?</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-metaprogramming" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Metaprogramming</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-metaprogramming"><li><h6 class="dropdown-header" data-toc-skip>Overviews</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-defuse.html">Defusing R expressions</a></li>
    <li><a class="dropdown-item" href="../reference/topic-inject.html">Injecting with `!!`, `!!!`, and glue syntax</a></li>
    <li><a class="dropdown-item" href="../reference/topic-metaprogramming.html">Metaprogramming patterns</a></li>
    <li><a class="dropdown-item" href="../reference/topic-quosure.html">What are quosures and when are they needed?</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-multiple-columns.html">Taking multiple columns without `...`</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-embrace-constants.html">Why are strings and other constants enquosed in the empty environment?</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-conditions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Conditions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-conditions"><li><h6 class="dropdown-header" data-toc-skip>Guides</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-error-call.html">Including function calls in error messages</a></li>
    <li><a class="dropdown-item" href="../reference/topic-error-chaining.html">Including contextual information with error chains</a></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-formatting.html">Formatting messages with cli</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Notes</h6></li>
    <li><a class="dropdown-item" href="../reference/topic-condition-customisation.html">Customising condition messages</a></li>
  </ul></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-news" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">News</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-news"><li><h6 class="dropdown-header" data-toc-skip>Releases</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2020/02/glue-strings-and-tidy-eval/">Version 0.4.3</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/06/rlang-0-4-0/">Version 0.4.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2019/01/rlang-0-3-1/">Version 0.3.1</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/10/rlang-0-3-0/">Version 0.3.0</a></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/articles/2018/03/rlang-0.2.0/">Version 0.2.0</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../news/index.html">Changelog</a></li>
  </ul></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/rlang/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic" id="container">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Evaluate an expression with quosures and pronoun support</h1>
      <small class="dont-index">Source: <a href="https://github.com/r-lib/rlang/blob/main/R/eval-tidy.R" class="external-link"><code>R/eval-tidy.R</code></a></small>
      <div class="d-none name"><code>eval_tidy.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p><code>eval_tidy()</code> is a variant of <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">base::eval()</a></code> that powers the tidy
evaluation framework. Like <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> it accepts user data as
argument. Whereas <code><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval()</a></code> simply transforms the data to an
environment, <code>eval_tidy()</code> transforms it to a <a href="topic-data-mask.html">data mask</a> with <code><a href="as_data_mask.html">as_data_mask()</a></code>. Evaluating in a data
mask enables the following features:</p><ul><li><p><a href="topic-quosure.html">Quosures</a>. Quosures are expressions bundled with
an environment. If <code>data</code> is supplied, objects in the data mask
always have precedence over the quosure environment, i.e. the
data masks the environment.</p></li>
<li><p><a href="dot-data.html">Pronouns</a>. If <code>data</code> is supplied, the <code>.env</code> and <code>.data</code>
pronouns are installed in the data mask. <code>.env</code> is a reference to
the calling environment and <code>.data</code> refers to the <code>data</code>
argument. These pronouns are an escape hatch for the <a href="topic-data-mask-ambiguity.html">data mask ambiguity</a> problem.</p></li>
</ul></div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">eval_tidy</span><span class="op">(</span><span class="va">expr</span>, data <span class="op">=</span> <span class="cn">NULL</span>, env <span class="op">=</span> <span class="fu"><a href="stack.html">caller_env</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-expr">expr<a class="anchor" aria-label="anchor" href="#arg-expr"></a></dt>
<dd><p>An <a href="topic-defuse.html">expression</a> or
<a href="topic-quosure.html">quosure</a> to evaluate.</p></dd>


<dt id="arg-data">data<a class="anchor" aria-label="anchor" href="#arg-data"></a></dt>
<dd><p>A data frame, or named list or vector. Alternatively, a
data mask created with <code><a href="as_data_mask.html">as_data_mask()</a></code> or
<code><a href="as_data_mask.html">new_data_mask()</a></code>. Objects in <code>data</code> have priority over those in
<code>env</code>. See the section about data masking.</p></dd>


<dt id="arg-env">env<a class="anchor" aria-label="anchor" href="#arg-env"></a></dt>
<dd><p>The environment in which to evaluate <code>expr</code>. This
environment is not applicable for quosures because they have
their own environments.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="when-should-eval-tidy-be-used-instead-of-eval-">When should eval_tidy() be used instead of eval()?<a class="anchor" aria-label="anchor" href="#when-should-eval-tidy-be-used-instead-of-eval-"></a></h2>



<p><code><a href="https://rdrr.io/r/base/eval.html" class="external-link">base::eval()</a></code> is sufficient for simple evaluation. Use
<code>eval_tidy()</code> when you'd like to support expressions referring to
the <code>.data</code> pronoun, or when you need to support quosures.</p>
<p>If you're evaluating an expression captured with
<a href="topic-inject.html">injection</a> support, it is recommended to use
<code>eval_tidy()</code> because users may inject quosures.</p>
<p>Note that unwrapping a quosure with <code><a href="quosure-tools.html">quo_get_expr()</a></code> does not
guarantee that there is no quosures inside the expression. Quosures
might be unquoted anywhere in the expression tree. For instance,
the following does not work reliably in the presence of nested
quosures:</p>
<p></p><div class="sourceCode"><pre><code><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>my_quoting_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  x <span class="ot">&lt;-</span> <span class="fu">enquo</span>(x)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  expr <span class="ot">&lt;-</span> <span class="fu">quo_get_expr</span>(x)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  env <span class="ot">&lt;-</span> <span class="fu">quo_get_env</span>(x)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="fu">eval</span>(expr, env)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co"># Works:</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">my_quoting_fn</span>(<span class="fu">toupper</span>(letters))</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co"># Fails because of a nested quosure:</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="fu">my_quoting_fn</span>(<span class="fu">toupper</span>(<span class="sc">!!</span><span class="fu">quo</span>(letters)))</span></code></pre><p></p></div>
    </div>
    <div class="section level2">
    <h2 id="stack-semantics-of-eval-tidy-">Stack semantics of <code>eval_tidy()</code><a class="anchor" aria-label="anchor" href="#stack-semantics-of-eval-tidy-"></a></h2>



<p><code>eval_tidy()</code> always evaluates in a data mask, even when <code>data</code> is
<code>NULL</code>. Because of this, it has different stack semantics than
<code><a href="https://rdrr.io/r/base/eval.html" class="external-link">base::eval()</a></code>:</p><ul><li><p>Lexical side effects, such as assignment with <code>&lt;-</code>, occur in the
mask rather than <code>env</code>.</p></li>
<li><p>Functions that require the evaluation environment to correspond
to a frame on the call stack do not work. This is why <code><a href="https://rdrr.io/r/base/function.html" class="external-link">return()</a></code>
called from a quosure does not work.</p></li>
<li><p>The mask environment creates a new branch in the tree
representation of backtraces (which you can visualise in a
<code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> session with <code>lobstr::cst()</code>).</p></li>
</ul><p>See also <code><a href="eval_bare.html">eval_bare()</a></code> for more information about these differences.</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index">
<ul><li><p><a href="topic-data-mask.html">What is data-masking and why do I need {{?</a>.</p></li>
<li><p><a href="topic-quosure.html">What are quosures and when are they needed?</a>.</p></li>
<li><p><a href="topic-defuse.html">Defusing R expressions</a>.</p></li>
<li><p><code><a href="as_data_mask.html">new_data_mask()</a></code> and <code><a href="as_data_mask.html">as_data_mask()</a></code> for manually creating data masks.</p></li>
</ul></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># With simple defused expressions eval_tidy() works the same way as</span></span></span>
<span class="r-in"><span><span class="co"># eval():</span></span></span>
<span class="r-in"><span><span class="va">fruit</span> <span class="op">&lt;-</span> <span class="st">"apple"</span></span></span>
<span class="r-in"><span><span class="va">vegetable</span> <span class="op">&lt;-</span> <span class="st">"potato"</span></span></span>
<span class="r-in"><span><span class="va">expr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">fruit</span>, <span class="va">vegetable</span>, sep <span class="op">=</span> <span class="st">" or "</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">expr</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> paste(fruit, vegetable, sep = " or ")</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "apple or potato"</span>
<span class="r-in"><span><span class="fu">eval_tidy</span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "apple or potato"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Both accept a data mask as argument:</span></span></span>
<span class="r-in"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fruit <span class="op">=</span> <span class="st">"banana"</span>, vegetable <span class="op">=</span> <span class="st">"carrot"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">expr</span>, <span class="va">data</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "banana or carrot"</span>
<span class="r-in"><span><span class="fu">eval_tidy</span><span class="op">(</span><span class="va">expr</span>, <span class="va">data</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "banana or carrot"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The main difference is that eval_tidy() supports quosures:</span></span></span>
<span class="r-in"><span><span class="va">with_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">expr</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">quo</span> <span class="op">&lt;-</span> <span class="fu"><a href="enquo.html">enquo</a></span><span class="op">(</span><span class="va">expr</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="fu">eval_tidy</span><span class="op">(</span><span class="va">quo</span>, <span class="va">data</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="fu">with_data</span><span class="op">(</span><span class="cn">NULL</span>, <span class="va">fruit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "apple"</span>
<span class="r-in"><span><span class="fu">with_data</span><span class="op">(</span><span class="va">data</span>, <span class="va">fruit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "banana"</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># eval_tidy() installs the `.data` and `.env` pronouns to allow</span></span></span>
<span class="r-in"><span><span class="co"># users to be explicit about variable references:</span></span></span>
<span class="r-in"><span><span class="fu">with_data</span><span class="op">(</span><span class="va">data</span>, <span class="va">.data</span><span class="op">$</span><span class="va">fruit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "banana"</span>
<span class="r-in"><span><span class="fu">with_data</span><span class="op">(</span><span class="va">data</span>, <span class="va">.env</span><span class="op">$</span><span class="va">fruit</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] "apple"</span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/lionel-" class="external-link">Lionel Henry</a>, <a href="https://hadley.nz" class="external-link">Hadley Wickham</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer></body></html>

